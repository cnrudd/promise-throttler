export default class PromiseThrottler{constructor(options){this.requestsPerSecond=options.requestsPerSecond;this.runSequentially=options.runSequentially===true;this.promiseImplementation=options.promiseImplementation??Promise;this.delayId=null;this.executing=false;this.queued=[]}add(promise){return this.addInternal(promise)}addAll(promises){const addedPromises=promises.map((promise,idx)=>{const dequeueImmediately=this.runSequentially?true:idx===promises.length-1;return this.addInternal(promise,dequeueImmediately)});return Promise.all(addedPromises)}addInternal(promise,dequeueImmediately=true){return new this.promiseImplementation((resolve,reject)=>{this.queued.push({resolve:resolve,reject:reject,promise:promise});if(dequeueImmediately&&!this.delayId&&!this.executing){this.dequeue()}})}dequeue(){if(this.queued.length===0){this.delayId=null;return}if(this.runSequentially){this.executeSequentially();return}this.executeInParallel()}executeSequentially(){const candidate=this.queued.shift();this.executing=true;candidate.promise().then(r=>{candidate.resolve(r)}).catch(r=>{candidate.reject(r)}).finally(()=>{const delay=Math.floor(1e3/this.requestsPerSecond);this.setupNextDequeue(delay)})}executeInParallel(){const pCount=this.requestsPerSecond>=1?this.requestsPerSecond:1;const delay=this.requestsPerSecond>=1?1e3:Math.floor(1e3/this.requestsPerSecond);const candidates=this.queued.splice(0,pCount);this.executing=true;Promise.all(candidates.map(candidate=>candidate.promise())).then(results=>{results.forEach((result,index)=>candidates[index].resolve(result))}).catch(reason=>{candidates.forEach(candidate=>candidate.reject(reason))}).finally(()=>{this.setupNextDequeue(delay)})}setupNextDequeue(delay){this.executing=false;this.delayId=setTimeout(()=>this.dequeue(),delay)}}